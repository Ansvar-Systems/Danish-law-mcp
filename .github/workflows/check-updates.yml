name: Daily Data Freshness Check

on:
  schedule:
    # Weekly at 05:00 UTC
    - cron: '0 5 * * 5'
  workflow_dispatch:
    inputs:
      auto_pr:
        description: 'Create auto-PR when updates are detected'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

jobs:
  monitor:
    name: Monitor Retsinformation updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.parse.outputs.has_updates }}
      update_count: ${{ steps.parse.outputs.update_count }}
      new_count: ${{ steps.parse.outputs.new_count }}
      summary_markdown: ${{ steps.parse.outputs.summary_markdown }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build database from seeds
        run: npm run build:db

      - name: Check for Danish law updates
        run: npm run check-updates -- --json > update-report.json

      - name: Parse monitor result
        id: parse
        run: |
          node -e '
          const fs = require("fs");
          const report = JSON.parse(fs.readFileSync("update-report.json", "utf8"));
          const updates = Array.isArray(report.updates) ? report.updates.length : 0;
          const newDocs = Array.isArray(report.new_documents) ? report.new_documents.length : 0;
          const hasUpdates = updates + newDocs > 0;

          const lines = [];
          lines.push("## Weekly Data Freshness Check");
          lines.push("");
          lines.push(`- Checked at: ${report.checked_at}`);
          lines.push(`- Local statutes: ${report.local_statutes}`);
          lines.push(`- Remote changed documents: ${report.remote_changed_documents}`);
          lines.push(`- Updates: ${updates}`);
          lines.push(`- New documents: ${newDocs}`);

          if (report.errors?.length) {
            lines.push("");
            lines.push("### Warnings");
            for (const err of report.errors) lines.push(`- ${err}`);
          }

          if (updates > 0) {
            lines.push("");
            lines.push("### Updated Local Documents");
            for (const item of report.updates.slice(0, 50)) {
              lines.push(`- ${item.local_id} (${item.local_title}) -> ${item.remote_accession} (${item.reason}, ${item.change_date})`);
            }
          }

          if (newDocs > 0) {
            lines.push("");
            lines.push("### New Candidate Documents");
            for (const item of report.new_documents.slice(0, 50)) {
              lines.push(`- ${item.inferred_id ?? "unknown-id"} [${item.type}] -> ${item.remote_accession} (${item.change_date})`);
            }
          }

          const summary = lines.join("\n");
          fs.writeFileSync("update-summary.md", `${summary}\n`);

          const out = fs.createWriteStream(process.env.GITHUB_OUTPUT, { flags: "a" });
          out.write(`has_updates=${hasUpdates}\n`);
          out.write(`update_count=${updates}\n`);
          out.write(`new_count=${newDocs}\n`);
          out.write("summary_markdown<<EOF\n");
          out.write(summary + "\n");
          out.write("EOF\n");
          out.end();
          '

      - name: Upload monitor artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: retsinformation-update-monitor
          path: |
            update-report.json
            update-summary.md
          retention-days: 30

      - name: Job summary
        run: cat update-summary.md >> "$GITHUB_STEP_SUMMARY"

  auto-pr:
    name: Auto-PR for update review
    needs: monitor
    runs-on: ubuntu-latest
    if: |
      needs.monitor.outputs.has_updates == 'true' &&
      (github.event_name == 'schedule' || github.event.inputs.auto_pr == 'true')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write monitor snapshot
        run: |
          mkdir -p .github/update-monitor
          cat > .github/update-monitor/latest-report.md <<'REPORT'
          ${{ needs.monitor.outputs.summary_markdown }}
          REPORT

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/daily-retsinformation-update-check
          title: "chore: daily Retsinformation update monitor"
          body: |
            Automated daily update monitor detected potential changes in Retsinformation.

            - Local updates: ${{ needs.monitor.outputs.update_count }}
            - New candidate documents: ${{ needs.monitor.outputs.new_count }}

            This PR updates the monitoring snapshot for maintainer review.
          commit-message: "chore: update daily Retsinformation monitor snapshot"
          add-paths: |
            .github/update-monitor/latest-report.md
          labels: |
            data-update
            automation
          delete-branch: true
